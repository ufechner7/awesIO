$schema: http://json-schema.org/draft-07/schema#
$id: operational_constraints_schema
title: Operational Constraints Schema
description: >
  Schema for all AWES operational constraints including pumping ground-gen,
  rotary ground-gen, and fly-gen systems.

type: object
required:
  - metadata

properties:
  metadata:
    type: object
    required:
      - name
      - description
      - note
      - awesIO_version
      - schema
      - system_type
    properties:
      name:
        type: string
        description: Human-readable name for this configuration
      description:
        type: string
        description: Detailed description of the operational constraints
      note:
        type: string
        description: Additional notes or caveats about this configuration
      awesIO_version:
        type: string
        description: Version of awesIO schema specification
      schema:
        type: string
        const: operational_constraints_schema.yml
        description: Reference to the schema file
      system_type:
        type: string
        enum:
          - pumping_ground_gen
          - rotary_ground_gen
          - fly_gen
        description: Type of AWES system these constraints apply to
    additionalProperties: false

  # Wind envelope constraints (common)
  wind_envelope:
    $ref: "#/definitions/wind_envelope"
  
  # Flight envelope constraints (common)
  flight_envelope:
    $ref: "#/definitions/flight_envelope"
  
  # Tether constraints (common)
  tether_constraints:
    $ref: "#/definitions/tether_constraints"
  
  # Cycle constraints (ground-gen only)
  cycle_constraints:
    $ref: "#/definitions/cycle_constraints"
  
  # Turbine constraints (fly-gen only)
  turbine_constraints:
    $ref: "#/definitions/turbine_constraints"
  
  # Electrical constraints (fly-gen only)
  electrical_constraints:
    $ref: "#/definitions/electrical_constraints"
  
  # Safety constraints (common)
  safety_constraints:
    $ref: "#/definitions/safety_constraints"
  
  # Airspace constraints (common)
  airspace_constraints:
    $ref: "#/definitions/airspace_constraints"

# Conditional validation based on system_type
allOf:
  # Pumping ground-gen may have cycle_constraints, should not have turbine/electrical
  - if:
      properties:
        metadata:
          properties:
            system_type:
              const: pumping_ground_gen
    then:
      properties:
        cycle_constraints:
          $ref: "#/definitions/cycle_constraints"
  
  # Rotary ground-gen - similar to pumping
  - if:
      properties:
        metadata:
          properties:
            system_type:
              const: rotary_ground_gen
    then:
      properties:
        cycle_constraints:
          $ref: "#/definitions/cycle_constraints"
  
  # Fly-gen may have turbine and electrical constraints
  - if:
      properties:
        metadata:
          properties:
            system_type:
              const: fly_gen
    then:
      properties:
        turbine_constraints:
          $ref: "#/definitions/turbine_constraints"
        electrical_constraints:
          $ref: "#/definitions/electrical_constraints"

additionalProperties: false

definitions:
  # Bound object for min/max/unit specifications
  bound_object:
    type: object
    properties:
      description:
        type: string
        description: Description of the constraint
      min:
        type: number
        description: Minimum value
      max:
        type: number
        description: Maximum value
      unit:
        type: string
        description: Unit of measurement
    additionalProperties: false

  # Wind envelope constraints
  wind_envelope:
    type: object
    properties:
      cut_in_wind_speed_m_s:
        type: number
        minimum: 0
        description: Minimum wind speed for operation in m/s
      rated_wind_speed_m_s:
        type: number
        minimum: 0
        description: Rated wind speed in m/s
      cut_out_wind_speed_m_s:
        type: number
        minimum: 0
        description: Maximum wind speed for operation in m/s
      max_turbulence_intensity:
        type: number
        minimum: 0
        maximum: 1
        description: Maximum allowed turbulence intensity (0-1)
      max_wind_shear:
        type: number
        minimum: 0
        description: Maximum allowed wind shear exponent
    additionalProperties: false

  # Flight envelope constraints
  flight_envelope:
    type: object
    properties:
      elevation_angle:
        $ref: "#/definitions/bound_object"
      azimuth_angle:
        $ref: "#/definitions/bound_object"
      altitude:
        $ref: "#/definitions/bound_object"
      flight_path_radius:
        $ref: "#/definitions/bound_object"
      max_bank_angle_deg:
        type: number
        minimum: 0
        maximum: 90
        description: Maximum bank angle in degrees
      max_acceleration_g:
        type: number
        minimum: 0
        description: Maximum acceleration in g-forces
      stall_margin:
        type: number
        minimum: 0
        maximum: 1
        description: Required stall margin (0-1)
    additionalProperties: false

  # Tether constraints
  tether_constraints:
    type: object
    properties:
      max_tether_force_n:
        type: number
        minimum: 0
        description: Maximum tether force in Newtons
      min_tether_force_n:
        type: number
        minimum: 0
        description: Minimum tether force in Newtons
      tether_length:
        $ref: "#/definitions/bound_object"
      max_tether_speed_m_s:
        type: number
        minimum: 0
        description: Maximum tether speed in m/s
    additionalProperties: false

  # Cycle constraints (ground-gen)
  cycle_constraints:
    type: object
    properties:
      reel_out_speed:
        $ref: "#/definitions/bound_object"
      reel_in_speed:
        $ref: "#/definitions/bound_object"
      reel_out_force:
        $ref: "#/definitions/bound_object"
      reel_in_force:
        $ref: "#/definitions/bound_object"
      min_cycle_time_s:
        type: number
        minimum: 0
        description: Minimum cycle time in seconds
      max_cycle_time_s:
        type: number
        minimum: 0
        description: Maximum cycle time in seconds
      transition_time_s:
        type: number
        minimum: 0
        description: Transition time between phases in seconds
      pattern_constraints:
        type: object
        properties:
          min_patterns_per_phase:
            type: integer
            minimum: 1
            description: Minimum number of patterns per phase
          max_patterns_per_phase:
            type: integer
            minimum: 1
            description: Maximum number of patterns per phase
        additionalProperties: false
    additionalProperties: false

  # Turbine constraints (fly-gen)
  turbine_constraints:
    type: object
    properties:
      min_rotor_speed_rpm:
        type: number
        minimum: 0
        description: Minimum rotor speed in RPM
      max_rotor_speed_rpm:
        type: number
        minimum: 0
        description: Maximum rotor speed in RPM
      rated_rotor_speed_rpm:
        type: number
        minimum: 0
        description: Rated rotor speed in RPM
      max_tip_speed_m_s:
        type: number
        minimum: 0
        description: Maximum tip speed in m/s
    additionalProperties: false

  # Electrical constraints (fly-gen)
  electrical_constraints:
    type: object
    properties:
      max_current_a:
        type: number
        minimum: 0
        description: Maximum current in Amperes
      max_voltage_v:
        type: number
        minimum: 0
        description: Maximum voltage in Volts
      max_power_kw:
        type: number
        minimum: 0
        description: Maximum power in kilowatts
    additionalProperties: false

  # Safety constraints
  safety_constraints:
    type: object
    properties:
      min_ground_clearance_m:
        type: number
        minimum: 0
        description: Minimum ground clearance in meters
      exclusion_zone_radius_m:
        type: number
        minimum: 0
        description: Exclusion zone radius in meters
      max_flight_duration_h:
        type: number
        minimum: 0
        description: Maximum flight duration in hours
      emergency_landing_speed_m_s:
        type: number
        minimum: 0
        description: Emergency landing speed in m/s
    additionalProperties: false

  # Airspace constraints
  airspace_constraints:
    type: object
    properties:
      max_altitude_agl_m:
        type: number
        minimum: 0
        description: Maximum altitude above ground level in meters
      max_altitude_msl_m:
        type: number
        minimum: 0
        description: Maximum altitude above mean sea level in meters
      restricted_zones:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            type:
              type: string
            coordinates:
              type: array
          additionalProperties: false
        description: List of restricted zones
    additionalProperties: false
